#! /usr/bin/env ruby
# coding: utf-8
#
# USAGE:
# qsubvasp [-n num] -c CLUSTER_NAME calc_dir
#
#   [-n INDICATOR]
#     Integer can be uused as INDICATOR.
#     If INDICATOR cannot be evaluated as positive integer,
#     try to find tue hostname of localhost and
#     key of
#     the INDICATOR in ~/.machineinfo
#     Default value is 1.
#
#   calc_dir must be a vasp geometry optimization directory.

#require "optparse"
require "yaml"
require "pp"

require "rubygems"
gem "comana"
require "comana/queuesubmitter.rb"
#require "comana/machineinfo.rb"

require "vasputils/vaspdir.rb"
require "vasputils/vaspgeomopt.rb"


OPTS = QueueSubmitter.parse_options(
  ARGV, MachineInfo.load_file("#{ENV["HOME"]}/.machineinfo")
)
OPTS[:directory] = VaspGeomOpt.new(File.expand_path(ARGV[0]))
OPTS[:command] = "runvasp -g"
#pp OPTS; exit

qs = QueueSubmitter.new(OPTS)
#pp qs; exit
begin
  qs.start
  puts "Submitted. Exit."
  exit
rescue QueueSubmitter::AlreadyStartedError
  puts "Already started. Exit."
  exit
rescue QueueSubmitter::PrepareNextError
  puts "Must not happen."
  exit
end
